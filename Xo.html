<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game C·ªù Caro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --glass-bg: rgba(10, 15, 30, 0.9);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #667eea; --accent: #f093fb; --gold: #ffd700; --text: #ffffff;
            --danger: #ff4757; --success: #2ed573;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { overflow: hidden; background: #020205; font-family: 'Outfit', sans-serif; color: var(--text); height: 100vh; width: 100vw; }
        canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI Layer - CƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; 
            display: flex; justify-content: center; align-items: center; 
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
        }
        #ui-layer.minimized { opacity: 0; transform: scale(0.8) translateY(100px); pointer-events: none; }

        /* Buttons Control */
        #btnShowUI {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%) scale(0);
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; z-index: 20; backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); opacity: 0; transition: 0.4s;
        }
        #ui-layer.minimized ~ #btnShowUI { transform: translateX(-50%) scale(1); opacity: 1; pointer-events: auto; }
        
        .btn-close-ui {
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px;
            background: rgba(255,255,255,0.1); border-radius: 50%; border: none; color: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.3s;
        }
        .btn-close-ui:hover { background: rgba(255,255,255,0.2); color: #fff; transform: rotate(90deg); }

        #music-control {
            pointer-events: auto; position: absolute; top: 20px; left: 20px;
            width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
            font-size: 18px; box-shadow: 0 0 15px rgba(102, 126, 234, 0.2); transition: 0.3s;
        }
        #music-control.playing { border-color: var(--primary); box-shadow: 0 0 20px var(--primary); animation: pulseMusic 2s infinite; }
        @keyframes pulseMusic { 0%,100%{box-shadow:0 0 10px var(--primary)} 50%{box-shadow:0 0 25px var(--primary)} }

        /* --- GAME PANEL (Responsive) --- */
        .game-panel { 
            pointer-events: auto; 
            width: 90%; 
            max-width: 420px; /* Mobile Default */
            background: var(--glass-bg); backdrop-filter: blur(25px) saturate(200%); -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.3); border-radius: 30px; 
            padding: 25px 20px; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.6); 
            opacity: 0; transform: translateY(50px); transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .game-panel.active { opacity: 1; transform: translateY(0); }

        /* LOGO STYLE - ƒê√£ thu nh·ªè */
        .game-logo {
            width: 100%; max-width: 150px; /* B√≥p nh·ªè logo */
            display: block; margin: 0 auto 15px;
            filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.6));
            animation: floatLogo 3s ease-in-out infinite;
        }
        @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

        input, select, button { width: 100%; padding: 14px; margin: 8px 0; background: rgba(255, 255, 255, 0.07); border: 1px solid var(--glass-border); border-radius: 14px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 15px; outline: none; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); background: rgba(255,255,255,0.12); box-shadow: 0 0 15px rgba(102, 126, 234, 0.2); }
        select option { background: #0f172a; }
        button { background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-top: 15px; box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); letter-spacing: 1px; }
        button:active { transform: scale(0.97); }
        .btn-red { background: rgba(255, 50, 50, 0.1); border: 1px solid rgba(255, 50, 50, 0.3); color: #ff8080; box-shadow: none; font-size: 13px; padding: 12px; margin-top: 10px; }
        
        /* Board */
        #board-container { width: 100%; aspect-ratio: 1/1; margin: 15px auto; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); padding: 4px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        #board { display: grid; width: 100%; height: 100%; gap: 1px; }
        .cell { background: rgba(255,255,255,0.04); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; transition: background 0.2s; }
        .cell:active { background: rgba(255,255,255,0.1); }
        .cell.X { color: #4facfe; text-shadow: 0 0 12px #4facfe; }
        .cell.O { color: #f093fb; text-shadow: 0 0 12px #f093fb; }
        #status-bar { display: flex; justify-content: space-between; font-weight: 600; font-size: 15px; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; }
        
        /* --- PC OPTIMIZATION (Media Query) --- */
        @media (min-width: 1024px) {
            .game-panel {
                max-width: 550px; /* TƒÉng k√≠ch th∆∞·ªõc tr√™n PC */
                padding: 40px;
                border-radius: 40px;
            }
            .game-logo {
                max-width: 180px; /* Logo PC to h∆°n t√≠ ch√∫t cho c√¢n */
            }
            input, select, button {
                padding: 18px;
                font-size: 16px;
                border-radius: 18px;
            }
            .cell {
                font-size: 28px !important; /* Ch·ªØ XO to r√µ tr√™n m√†n PC */
            }
            #roomIdDisplay {
                font-size: 16px !important;
                padding: 12px !important;
            }
        }

        /* POPUP MODAL */
        .overlay-popup { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.92); z-index: 50; border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); animation: fadeIn 0.3s ease; padding: 20px; text-align: center; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .hidden { display: none !important; }
        
        .avatar-box { width: 60px; height: 60px; margin: 0 auto 5px; position: relative; }
        .avatar-box img.main { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }
        .avatar-box img.frame { position: absolute; top: -16%; left: -16%; width: 132%; height: 132%; pointer-events: none; }
        
        /* Kick Button */
        .btn-kick-user {
            position: absolute; top: -5px; right: -5px; width: 22px; height: 22px;
            background: var(--danger); border-radius: 50%; border: 2px solid #fff;
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; box-shadow: 0 0 10px var(--danger); z-index: 5;
            transition: 0.3s;
        }
        .btn-kick-user:active { transform: scale(0.9); }

        /* Popup Buttons Styling */
        .popup-action-btn { width: 100%; margin: 5px 0; padding: 12px; font-size: 14px; border-radius: 10px; }

        /* Room ID Badge */
        #roomIdDisplay {
            text-align: center; color: rgba(255,255,255,0.5); font-size: 13px; 
            margin-bottom: 10px; background: rgba(255,255,255,0.05); 
            padding: 8px; border-radius: 8px; cursor: pointer; border: 1px dashed rgba(255,255,255,0.2);
        }
        #roomIdDisplay:active { background: rgba(255,255,255,0.1); color: #fff; }

    </style>
</head>
<body>

    <canvas id="neural-network-canvas"></canvas>

    <audio id="bgMusic" loop><source src="https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3?filename=space-chillout-14194.mp3" type="audio/mpeg"></audio>
    <div id="music-control">üîá</div>

    <div id="toastMsg" style="position:absolute; top:80px; left:50%; transform:translateX(-50%); background:rgba(0,255,100,0.2); border:1px solid #0f0; padding:10px 20px; border-radius:20px; color:#fff; display:none; z-index:100; backdrop-filter:blur(5px); font-size:14px; text-align:center;"></div>

    <div id="ui-layer">
        
        <div id="home" class="game-panel">
            <button class="btn-close-ui" onclick="hideUI()">‚úï</button>
            
            <img src="https://i.ibb.co/7dH7bbgJ/file-0000000029007206a9ef63a171b1b0bd-removebg-preview.png" class="game-logo" alt="Caro Quantum">

            <div id="previewArea" class="hidden">
                <div class="avatar-box"><img id="previewImg" class="main" src=""><img class="frame" src="https://i.postimg.cc/FFqqqbzz/khung-vip-303.gif"></div>
            </div>
            <input id="inpName" placeholder="T√™n c·ªßa b·∫°n" autocomplete="off">
            <input id="inpAvatar" placeholder="Link Avatar (N·∫øu c√≥)" autocomplete="off">
            <select id="inpSize">
                <option value="15">ü™ê 15x15 (V≈© Tr·ª•)</option>
                <option value="10">‚ö° 10x10 (Si√™u T·ªëc)</option>
                <option value="5">üî• 5x5 (T·ª≠ Chi·∫øn)</option>
            </select>
            <input id="inpRoom" placeholder="M√£ Ph√≤ng (5-30 s·ªë)" type="tel" maxlength="30" autocomplete="off">
            <button id="btnJoin">üöÄ V√ÄO CHI·∫æN NGAY</button>
            <button class="btn-red" id="btnClear">X√≥a d·ªØ li·ªáu c≈©</button>
        </div>

        <div id="game" class="game-panel hidden">
            <button class="btn-close-ui" onclick="hideUI()">‚úï</button>
            
            <div id="roomIdDisplay" onclick="copyRoomId()">Ph√≤ng: ... (Ch·∫°m ƒë·ªÉ sao ch√©p)</div>

            <div id="overlayPopup" class="overlay-popup hidden">
                <h3 id="popupTitle" style="color:var(--gold); margin-bottom:15px; text-align:center; padding:0 10px;">TH√îNG B√ÅO</h3>
                
                <div id="rematchProgressBox" style="width:80%; height:4px; background:#333; margin-bottom:20px; border-radius:2px; overflow:hidden;" class="hidden">
                    <div id="rematchProgress" style="width:0%; height:100%; background:var(--gold)"></div>
                </div>

                <div id="popupButtons" style="width:100%; display:flex; flex-direction:column; gap:10px; align-items:center;">
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <div id="pX" style="text-align:center; width:35%; position:relative;"></div>
                <div style="font-size:24px; color:rgba(255,255,255,0.1); font-weight:900">VS</div>
                <div id="pO" style="text-align:center; width:35%; position:relative;"></div>
            </div>

            <div id="board-container"><div id="board"></div></div>
            <div id="status-bar">
                <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
                <span id="timerText">--:--</span>
            </div>
            <div id="endControls" class="hidden" style="display:flex; gap:10px">
                <button id="btnRematch" style="margin-top:15px">üîÑ V√°n M·ªõi</button>
                <button id="btnLeave" class="btn-red" style="margin-top:15px; border-color:rgba(255,255,255,0.2)">Tho√°t</button>
            </div>
        </div>
    </div>

    <div id="btnShowUI" onclick="showUI()">üëÅÔ∏è</div>

    <script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        const nodeShader = {
            vertexShader: `attribute float size; attribute vec3 color; varying vec3 vColor; uniform float uTime; void main() { vColor = color; vec3 pos = position; pos *= 1.0 + 0.05 * sin(uTime * 0.5 + position.x); vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0); gl_PointSize = size * (300.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }`,
            fragmentShader: `varying vec3 vColor; uniform float uTime; void main() { vec2 center = 2.0 * gl_PointCoord - 1.0; float dist = length(center); if (dist > 1.0) discard; float glow = 1.0 - dist; glow = pow(glow, 1.5); float twinkle = 0.6 + 0.4 * sin(uTime * 3.0 + vColor.x * 20.0 + vColor.y * 10.0); gl_FragColor = vec4(vColor, glow * twinkle); }`
        };

        const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x020205, 0.002);
        const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 2000); camera.position.z = 120;
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('neural-network-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.6, 0.5, 0.8));
        composer.addPass(new OutputPass());

        function createStars() {
            const geo = new THREE.BufferGeometry(); const pos = [];
            for(let i=0; i<5000; i++) pos.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            scene.add(new THREE.Points(geo, new THREE.PointsMaterial({color: 0xaaddee, size: 1.5, transparent:true, opacity:0.8, fog:true})));
        }
        createStars();

        const pGroup = new THREE.Group();
        const posP=[], colP=[], sizeP=[], posConn=[], nodes=[], palette=[new THREE.Color('#667eea'), new THREE.Color('#764ba2'), new THREE.Color('#f093fb'), new THREE.Color('#4facfe')];
        for(let i=0; i<250; i++) {
            const r=30*Math.cbrt(Math.random()), theta=Math.random()*Math.PI*2, phi=Math.acos(2*Math.random()-1);
            const x=r*Math.sin(phi)*Math.cos(theta), y=r*Math.sin(phi)*Math.sin(theta), z=r*Math.cos(phi);
            posP.push(x,y,z); nodes.push(new THREE.Vector3(x,y,z));
            const c=palette[Math.floor(Math.random()*4)]; colP.push(c.r,c.g,c.b); sizeP.push(Math.random()*1.5+0.5);
        }
        for(let i=0;i<250;i++) for(let j=i+1;j<250;j++) if(nodes[i].distanceTo(nodes[j])<8) posConn.push(nodes[i].x,nodes[i].y,nodes[i].z,nodes[j].x,nodes[j].y,nodes[j].z);
        
        pGroup.add(new THREE.LineSegments(new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(posConn,3)), new THREE.LineBasicMaterial({color:0x667eea, transparent:true, opacity:0.15})));
        const matP = new THREE.ShaderMaterial({uniforms:{uTime:{value:0}}, vertexShader:nodeShader.vertexShader, fragmentShader:nodeShader.fragmentShader, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending});
        const geoP = new THREE.BufferGeometry();
        geoP.setAttribute('position', new THREE.Float32BufferAttribute(posP,3)); geoP.setAttribute('color', new THREE.Float32BufferAttribute(colP,3)); geoP.setAttribute('size', new THREE.Float32BufferAttribute(sizeP,1));
        pGroup.add(new THREE.Points(geoP, matP)); scene.add(pGroup);

        const textureLoader = new THREE.TextureLoader();
        const satMap = textureLoader.load('https://i.postimg.cc/13bfGhtB/pngtree-satellite-isolated-on-transparent-background-png-image-16786689-removebg-preview.png');
        const satMat = new THREE.SpriteMaterial({ map: satMap, transparent: true });
        const satellite = new THREE.Sprite(satMat); satellite.scale.set(12, 12, 1); scene.add(satellite);

        const ufoMap = textureLoader.load('https://i.postimg.cc/vTG14rBZ/cute-alien-riding-ufo-space-cartoon-vector-icon-illustration-science-technology-icon-isolated-138676.png');
        const ufoMat = new THREE.SpriteMaterial({ map: ufoMap, transparent: true });
        const ufo = new THREE.Sprite(ufoMat); ufo.scale.set(15, 15, 1); ufo.position.set(-200, 40, -100); scene.add(ufo);

        const clock = new THREE.Clock(); let intro=false;
        function animate() {
            requestAnimationFrame(animate); const t=clock.getElapsedTime();
            pGroup.rotation.y=t*0.05; matP.uniforms.uTime.value=t;
            satellite.position.set(Math.cos(t*0.8)*60, Math.sin(t*0.4)*20, Math.sin(t*0.8)*60);
            ufo.position.x += 0.5; if(ufo.position.x > 200) ufo.position.x = -200; ufo.material.rotation = Math.sin(t * 2) * 0.1;
            if(!intro) { camera.position.z = THREE.MathUtils.lerp(camera.position.z, 60, 0.02); if(camera.position.z<65) { intro=true; document.getElementById('home').classList.add('active'); } }
            composer.render();
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); });
    </script>

    <script>
        // --- UI UTILS ---
        const uiLayer = document.getElementById('ui-layer');
        window.hideUI = () => uiLayer.classList.add('minimized');
        window.showUI = () => uiLayer.classList.remove('minimized');
        
        function showToast(msg, type='info') {
            const t = document.getElementById("toastMsg");
            t.textContent = msg; t.style.display='block'; t.style.borderColor = type==='error'?'#ff4757':'#0f0'; t.style.background = type==='error'?'rgba(255,71,87,0.2)':'rgba(0,255,100,0.2)';
            setTimeout(()=>t.style.display='none', 3000);
        }

        window.copyRoomId = () => {
            if(roomId) {
                navigator.clipboard.writeText(roomId);
                showToast("ƒê√£ sao ch√©p m√£ ph√≤ng!", "info");
            }
        }

        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('music-control');
        let isMusicPlaying = false;
        musicBtn.addEventListener('click', () => {
            if(isMusicPlaying) { bgMusic.pause(); musicBtn.textContent='üîá'; musicBtn.classList.remove('playing'); }
            else { bgMusic.play(); musicBtn.textContent='üéµ'; musicBtn.classList.add('playing'); }
            isMusicPlaying = !isMusicPlaying;
        });

        // --- GAME LOGIC ---
        const db = firebase.initializeApp({ apiKey: "AIzaSyBdKC3vCBjHhsakrE1hUYg-2_Vi9JYX3vk", databaseURL: "https://noitu-7dca6-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "noitu-7dca6" }).database();
        const FRAME_GIF = "https://i.postimg.cc/FFqqqbzz/khung-vip-303.gif";
        
        let roomId="", myRole="", uid=localStorage.uid||(localStorage.uid=Math.random().toString(36).substr(2,9)); 
        let timerInt=null, isLeaving=false, hasOpponent=false;
        const els = { 
            home: document.getElementById("home"), game: document.getElementById("game"), board: document.getElementById("board"), 
            status: document.getElementById("statusText"), timer: document.getElementById("timerText"), pX: document.getElementById("pX"), pO: document.getElementById("pO"), 
            popup: document.getElementById("overlayPopup"), popupTitle: document.getElementById("popupTitle"), 
            popupBtns: document.getElementById("popupButtons"), rematchBarBox: document.getElementById("rematchProgressBox"), rematchBar: document.getElementById("rematchProgress"),
            endControls: document.getElementById("endControls"), roomDisplay: document.getElementById("roomIdDisplay")
        };

        window.onload = () => {
            if(localStorage.uName) document.getElementById("inpName").value = localStorage.uName;
            if(localStorage.uAva) { document.getElementById("inpAvatar").value = localStorage.uAva; document.getElementById("previewImg").src = localStorage.uAva; document.getElementById("previewArea").classList.remove('hidden'); }
        };
        document.getElementById("inpAvatar").oninput = (e) => { const v=e.target.value.trim(); if(v){document.getElementById("previewImg").src=v;document.getElementById("previewArea").classList.remove('hidden');} };
        document.getElementById("btnClear").onclick = () => { localStorage.clear(); location.reload(); };

        // === JOIN ROOM ===
        document.getElementById("btnJoin").onclick = () => {
            const name = document.getElementById("inpName").value.trim(); const ava = document.getElementById("inpAvatar").value.trim(); 
            roomId = document.getElementById("inpRoom").value.trim(); const size = parseInt(document.getElementById("inpSize").value);
            if(!name || roomId.length < 5 || roomId.length > 30) return alert("‚ö†Ô∏è T√™n & M√£ ph√≤ng (5-30 s·ªë)!");
            
            localStorage.uName=name; localStorage.uAva=ava;
            if(!isMusicPlaying) musicBtn.click();
            els.home.classList.remove('active'); setTimeout(() => els.home.classList.add('hidden'), 600);
            els.game.classList.remove('hidden'); setTimeout(() => els.game.classList.add('active'), 100);

            els.roomDisplay.textContent = `Ph√≤ng: ${roomId} (Ch·∫°m ƒë·ªÉ sao ch√©p)`;

            // Auto Clean Room c≈©
            db.ref("rooms/"+roomId).transaction(r => {
                const NOW = Date.now();
                if (r && r.turnTime && (NOW - r.turnTime > 30 * 60 * 1000)) {
                    r = { boardSize: size, board: Array(size*size).fill(""), players: {}, turn: "X", startTime: NOW, turnTime: NOW };
                }
                
                if(!r) r = { boardSize: size, board: Array(size*size).fill(""), players:{}, turn:"X", startTime: NOW, turnTime: NOW };
                
                let p = { name, ava, id: uid, isHost: false };
                
                // === CHECK HOST C·∫®N TH·∫¨N (Tr√°nh 2 Vua) ===
                const x = r.players.X;
                const o = r.players.O;
                
                // 1. Ki·ªÉm tra xem ph√≤ng ƒê√É C√ì ai l√† Host ch∆∞a?
                const existingHost = (x && x.isHost) || (o && o.isHost);

                // 2. N·∫øu ch∆∞a c√≥ ai l√† Host (ph√≤ng tr·ªëng ho·∫∑c Host c≈© v·ª´a out), th√¨ m√¨nh l√†m Host
                if (!existingHost) {
                    p.isHost = true;
                } else {
                    // N·∫øu ƒë√£ c√≥ Host r·ªìi, m√¨nh v√†o sau -> Kh√¥ng ƒë∆∞·ª£c l√†m Host
                    p.isHost = false;
                }

                if(!r.players.X) { myRole="X"; r.players.X = p; } 
                else if(!r.players.O) { myRole="O"; r.players.O = p; }
                else if(r.players.X.id===uid) { myRole="X"; r.players.X.name=name; r.players.X.avatar=ava; }
                else if(r.players.O.id===uid) { myRole="O"; r.players.O.name=name; r.players.O.avatar=ava; }
                
                if(r.players.X && r.players.O && (!r.gameStarted)) {
                    r.gameStarted = true;
                    r.turnTime = NOW; 
                }

                return r;
            }, (error, committed) => {
                if(committed) {
                    db.ref("rooms/" + roomId + "/players/" + myRole).onDisconnect().remove();
                    listenRoom();
                }
            });
        };

        function listenRoom() {
            db.ref("rooms/"+roomId).on("value", snap => {
                const r = snap.val(); if(!r) return;
                
                const oppRole = myRole==="X"?"O":"X";
                const isOpponentPresent = r.players && r.players[oppRole];

                if (hasOpponent && !isOpponentPresent) {
                    showToast("üö™ ƒê·ªëi th·ªß ƒë√£ r·ªùi ph√≤ng", "info");
                }
                hasOpponent = !!isOpponentPresent;

                // === LOGIC HOST M·ªöI (CHUY·ªÇN GIAO T·ª®C TH√å) ===
                if(r.players && r.players[myRole]) {
                    // N·∫øu t√¥i ch∆∞a l√† Host
                    if(!r.players[myRole].isHost) {
                        // V√† t√¥i kh√¥ng th·∫•y ƒë·ªëi th·ªß ƒë√¢u c·∫£ (ho·∫∑c ƒë·ªëi th·ªß kh√¥ng ph·∫£i Host)
                        // Trong tr∆∞·ªùng h·ª£p ƒë·ªëi th·ªß out -> T√¥i l√† ng∆∞·ªùi duy nh·∫•t -> L√™n ng√¥i
                        if(!isOpponentPresent) {
                             db.ref("rooms/"+roomId+"/players/"+myRole).update({isHost: true});
                             showToast("üëë B·∫°n ƒë√£ tr·ªü th√†nh Ch·ªß ph√≤ng!", "success");
                        }
                    }
                }

                if(r.players && !r.players[myRole]) {
                    if(!isLeaving) {
                        alert("üö´ B·∫†N ƒê√É B·ªä K√çCH KH·ªéI PH√íNG!");
                        location.reload();
                    }
                    return;
                }

                renderPlayers(r.players); renderBoard(r.board, r.boardSize, r.winner); updateStatus(r); 
                handleRematch(r.rematch);
                handleKickRequest(r.kick);
            });
        }

        function renderPlayers(p) {
            const tmpl = (u, role) => {
                if(!u) return `<div style="font-size:12px; color:#aaa; margin-top:20px;">ƒêang ƒë·ª£i...</div>`;
                
                let kickBtnHTML = "";
                const isMeHost = p[myRole] && p[myRole].isHost;
                if(isMeHost && role !== myRole) {
                    kickBtnHTML = `<div class="btn-kick-user" onclick="showHostControls('${role}')">‚õî</div>`;
                }

                return `
                    <div class="avatar-box">
                        <img class="main" src="${u.avatar||'https://via.placeholder.com/60?text=?'}">
                        <img class="frame" src="${FRAME_GIF}">
                        ${kickBtnHTML}
                    </div>
                    <div style="font-size:13px; font-weight:700; color:${role==='X'?'#4facfe':'#f093fb'}; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                        ${u.isHost ? 'üëë ' : ''}${u.name}
                    </div>`;
            };
            
            els.pX.innerHTML = tmpl(p?.X, 'X'); 
            els.pO.innerHTML = tmpl(p?.O, 'O');
        }

        // ==========================================
        //  ‚ö°‚ö°‚ö° LOGIC QU·∫¢N L√ù PH√íNG ‚ö°‚ö°‚ö°
        // ==========================================

        window.showHostControls = (targetRole) => {
            els.popup.classList.remove('hidden');
            els.popupTitle.textContent = "QU·∫¢N L√ù PH√íNG";
            els.popupTitle.style.color = "var(--gold)";
            els.rematchBarBox.classList.add('hidden'); 

            els.popupBtns.innerHTML = `
                <div style="color:#ddd; font-size:13px; margin-bottom:10px">Ch·ªçn h√†nh ƒë·ªông v·ªõi ƒë·ªëi th·ªß:</div>
                <button class="popup-action-btn" style="background:#44bd32" onclick="inviteKick('${targetRole}')">M·ªùi ra ngo√†i </button>
                <button class="popup-action-btn" style="background:var(--danger)" onclick="forceKick('${targetRole}')"> K√≠ch ngay </button>
                <button class="popup-action-btn" style="background:#555" onclick="hidePopup()">Quay l·∫°i</button>
            `;
        };

        window.inviteKick = (targetRole) => {
            db.ref("rooms/"+roomId+"/kick").set({ target: targetRole, type: 'invite', time: Date.now() });
            els.popupTitle.textContent = "ƒêANG G·ª¨I Y√äU C·∫¶U...";
            els.popupBtns.innerHTML = `<div style="color:#aaa; padding:20px;">ƒêang ch·ªù ƒë·ªëi th·ªß x√°c nh·∫≠n...</div><button class="popup-action-btn" style="background:#555" onclick="hidePopup()">ƒê√≥ng</button>`;
        };

        window.forceKick = (targetRole) => {
            if(confirm("X√°c nh·∫≠n ƒëu·ªïi ng∆∞·ªùi n√†y ngay l·∫≠p t·ª©c?")) {
                db.ref("rooms/"+roomId+"/players/"+targetRole).remove()
                .then(() => {
                    db.ref("rooms/"+roomId+"/kick").remove();
                    hidePopup();
                    showToast("ƒê√£ d·ªçn d·∫πp ph√≤ng th√†nh c√¥ng!", "success");
                });
            }
        };

        function handleKickRequest(kickData) {
            // LOGIC T·ª™ CH·ªêI: CH·ªà HI·ªÜN CHO HOST, KH√îNG HI·ªÜN CHO VICTIM
            if (kickData && kickData.status === 'refused') {
                if (myRole !== kickData.target) { // N·∫øu t√¥i kh√¥ng ph·∫£i l√† ng∆∞·ªùi g·ª≠i t·ª´ ch·ªëi (t·ª©c t√¥i l√† Host)
                    showToast("‚ö†Ô∏è ƒê·ªëi th·ªß t·ª´ ch·ªëi ra ngo√†i!", "error");
                    if(els.popupTitle.textContent.includes("ƒêANG G·ª¨I")) hidePopup();
                }
                
                // Clean DB (Host l√†m)
                db.ref("rooms/"+roomId+"/players/"+myRole).once('value', snap => {
                    if(snap.val() && snap.val().isHost) {
                         setTimeout(() => db.ref("rooms/"+roomId+"/kick").remove(), 2000);
                    }
                });
                return; // QUAN TR·ªåNG: D·ª´ng l·∫°i ƒë·ªÉ kh√¥ng ch·∫°y xu·ªëng logic hi·ªán popup b√™n d∆∞·ªõi
            }

            if(!kickData || kickData.target !== myRole) {
                if(els.popupTitle.textContent.includes("B·ªä M·ªúI RA")) els.popup.classList.add('hidden');
                return;
            }

            if(kickData.type === 'invite') {
                els.popup.classList.remove('hidden');
                els.popupTitle.textContent = "üö´ B·∫†N B·ªä M·ªúI RA";
                els.popupTitle.style.color = "var(--danger)";
                els.rematchBarBox.classList.add('hidden');
                
                els.popupBtns.innerHTML = `
                    <div style="text-align:center; color:#fff; margin-bottom:15px;">Ch·ªß ph√≤ng mu·ªën m·ªùi b·∫°n r·ªùi kh·ªèi ph√≤ng.</div>
                    <div style="display:flex; gap:10px; width:100%">
                        <button class="popup-action-btn" style="background:var(--danger)" onclick="leaveRoom()">üö™ ƒê·ªìng √Ω r·ªùi ph√≤ng</button>
                        <button class="popup-action-btn" style="background:#444" onclick="declineKick()">üõ°Ô∏è T·ª´ ch·ªëi</button>
                    </div>
                `;
            }
        }

        window.declineKick = () => {
            els.popup.classList.add('hidden');
            // G·ª≠i t√≠n hi·ªáu T·ª™ CH·ªêI k√®m theo target l√† CH√çNH M√åNH (ƒë·ªÉ code tr√™n nh·∫≠n di·ªán)
            db.ref("rooms/"+roomId+"/kick").update({ status: 'refused', target: myRole });
        };

        window.hidePopup = () => els.popup.classList.add('hidden');
        window.leaveRoom = () => {
             isLeaving = true; 
             db.ref("rooms/"+roomId+"/players/"+myRole).remove().then(() => location.reload());
        }

        // ==========================================

        function handleRematch(rematch) {
            if(!els.popup.classList.contains('hidden') && 
               (els.popupTitle.textContent.includes("QU·∫¢N L√ù") || els.popupTitle.textContent.includes("M·ªúI RA") || els.popupTitle.textContent.includes("ƒêANG G·ª¨I"))) return;

            if(!rematch) {
                els.popup.classList.add("hidden");
                document.getElementById("btnRematch").textContent = "üîÑ V√°n M·ªõi";
                return;
            }
            
            const now = Date.now();
            if(now - rematch.time > 5000) { 
                if(rematch.from === myRole) db.ref("rooms/"+roomId+"/rematch").remove();
                return;
            }

            if(rematch.status === 'declined') {
                if(rematch.from === myRole) {
                    els.popup.classList.remove("hidden");
                    els.popupTitle.textContent = "‚ùå ƒê·ªêI TH·ª¶ T·ª™ CH·ªêI";
                    els.popupTitle.style.color = "var(--danger)";
                    els.rematchBarBox.classList.add("hidden");
                    els.popupBtns.innerHTML = "";
                    setTimeout(() => { els.popup.classList.add("hidden"); db.ref("rooms/"+roomId+"/rematch").remove(); }, 2000);
                }
                return;
            }

            els.popup.classList.remove("hidden");
            els.rematchBarBox.classList.remove("hidden");
            const bar = els.rematchBar;
            bar.style.transition = 'none'; bar.style.width = '100%';
            setTimeout(() => { bar.style.transition = `width linear ${5000 - (now - rematch.time)}ms`; bar.style.width = '0%'; }, 50);

            if(rematch.from !== myRole) {
                els.popupTitle.textContent = "üî• TH√ÅCH ƒê·∫§U L·∫†I?";
                els.popupTitle.style.color = "var(--gold)";
                els.popupBtns.innerHTML = `
                    <div style="display:flex; gap:15px; width:100%">
                        <button class="popup-action-btn" onclick="acceptRematch()" style="background:var(--primary); margin:0">CHI·∫æN!</button>
                        <button class="popup-action-btn" onclick="declineRematch()" style="background:#444; margin:0">TH√îI</button>
                    </div>
                `;
            } else {
                els.popupTitle.textContent = "‚è≥ ƒêANG CH·ªú...";
                els.popupTitle.style.color = "#fff";
                els.popupBtns.innerHTML = "";
            }
        }

        window.acceptRematch = () => {
            db.ref("rooms/"+roomId).transaction(r => {
                if(r) { r.board=Array(r.boardSize*r.boardSize).fill(""); r.winner=null; r.turn="X"; r.startTime=Date.now(); r.turnTime=Date.now(); r.rematch=null; } return r;
            });
            els.popup.classList.add("hidden");
        };
        window.declineRematch = () => {
            els.popup.classList.add("hidden");
            db.ref("rooms/"+roomId+"/rematch").update({status: 'declined', time: firebase.database.ServerValue.TIMESTAMP});
        };

        function renderBoard(board, size, winner) {
            els.board.innerHTML = ""; els.board.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            const fSize = size>=15?"10px":(size>=10?"14px":"22px");
            board.forEach((cell, i) => {
                const d = document.createElement("div"); d.className = `cell ${cell}`; d.textContent = cell; d.style.fontSize = fSize;
                if(!winner) d.onclick = () => move(i); els.board.appendChild(d);
            });
        }

        function updateStatus(r) {
            clearInterval(timerInt);
            if(!r.players?.X || !r.players?.O) { 
                els.status.textContent = "‚è≥ ƒêang ƒë·ª£i ƒë·ªëi th·ªß..."; 
                els.timer.textContent = "--:--";
                els.endControls.classList.add("hidden");
                return; 
            }

            if(r.winner) {
                els.status.innerHTML = r.winner==="draw"?"H√íA!":`<span style='color:${r.winner==='X'?'#4facfe':'#f093fb'}'>${r.players[r.winner].name} TH·∫ÆNG!</span>`;
                els.endControls.classList.remove("hidden"); els.timer.textContent = "END";
            } else {
                els.endControls.classList.add("hidden"); const isTurn = r.turn === myRole;
                els.status.textContent = isTurn ? "üëâ L∆∞·ª£t c·ªßa b·∫°n" : "‚è≥ ƒê·ªëi th·ªß ƒëang nghƒ©..."; els.status.style.color = isTurn ? "#4facfe" : "#aaa";
                
                timerInt = setInterval(() => {
                    const left = Math.max(0, 15 - Math.floor((Date.now()-r.turnTime)/1000));
                    els.timer.textContent = `‚è± ${left}s`;
                    if(left===0 && isTurn && !r.winner) db.ref("rooms/"+roomId).update({winner: myRole==="X"?"O":"X"});
                }, 1000);
            }
        }

        function move(i) {
            db.ref("rooms/"+roomId).once("value", snap => {
                const r = snap.val();
                if(r && r.turn===myRole && !r.board[i] && !r.winner && r.players.X && r.players.O) {
                    r.board[i] = myRole;
                    // --- FIXED 5x5 LOGIC ---
                    if(checkWin(r.board, i, r.boardSize)) r.winner = myRole; else if(!r.board.includes("")) r.winner = "draw";
                    else { r.turn = myRole==="X"?"O":"X"; r.turnTime = firebase.database.ServerValue.TIMESTAMP; }
                    db.ref("rooms/"+roomId).update(r);
                }
            });
        }

        function checkWin(b, i, size) {
            const x = i % size, y = Math.floor(i / size), val = b[i];
            const dirs = [[1, 0], [0, 1], [1, 1], [1, -1]];
            for (let [dx, dy] of dirs) {
                let c = 1;
                for (let s = 1; s < 5; s++) {
                    const nx = x + dx * s, ny = y + dy * s;
                    if (nx < 0 || nx >= size || ny < 0 || ny >= size) break;
                    if (b[ny * size + nx] === val) c++; else break;
                }
                for (let s = 1; s < 5; s++) {
                    const nx = x - dx * s, ny = y - dy * s;
                    if (nx < 0 || nx >= size || ny < 0 || ny >= size) break;
                    if (b[ny * size + nx] === val) c++; else break;
                }
                if (c >= 5) return true;
            }
            return false;
        }

        document.getElementById("btnRematch").onclick = () => {
            document.getElementById("btnRematch").textContent = "ƒê√£ g·ª≠i...";
            db.ref("rooms/"+roomId+"/rematch").set({from:myRole, status:'pending', time: firebase.database.ServerValue.TIMESTAMP});
        };
        
        document.getElementById("btnLeave").onclick = () => { 
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën tho√°t?")) { 
                isLeaving = true; 
                db.ref("rooms/"+roomId+"/players/"+myRole).remove().then(() => location.reload()); 
            } 
        };
    </script>
</body>
</html>
